<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title
	th:text="${modo == 'nuevo'} ? 'Nueva Reserva - CRUISEMANAGER' : 'Editar Reserva - CRUISEMANAGER'">Reserva</title>

<!-- CSS Libraries -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
/* Variables de colores */
:root {
	--primary-gradient: linear-gradient(90deg, #0d6efd, #20c997);
	--background-gradient: linear-gradient(135deg, #f0f4f9, #d9e4f5);
	--card-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
	--hover-transition: all 0.3s ease-in-out;
	--success-gradient: linear-gradient(45deg, #198754, #20c997);
	--danger-color: #dc3545;
}

/* Estilos generales */
body {
	background: var(--background-gradient);
	font-family: "Poppins", sans-serif;
	min-height: 100vh;
}

/* Card principal */
.main-card {
	border-radius: 1.2rem;
	box-shadow: var(--card-shadow);
	overflow: hidden;
	margin-top: 2rem;
	border: none;
	max-width: 800px;
	margin-left: auto;
	margin-right: auto;
}

.card-header-custom {
	background: var(--primary-gradient);
	color: white;
	font-weight: 600;
	letter-spacing: 1px;
	padding: 1.5rem;
	font-size: 1.3rem;
	border-bottom: none;
	display: flex;
	align-items: center;
	gap: 0.75rem;
}

/* Botones */
.btn-custom {
	border-radius: 2rem;
	padding: 0.6rem 1.5rem;
	font-weight: 500;
	transition: var(--hover-transition);
	border: none;
	display: inline-flex;
	align-items: center;
	gap: 0.5rem;
}

.btn-custom:hover {
	transform: translateY(-2px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-success-custom {
	background: var(--success-gradient);
	color: white;
}

.btn-secondary-custom {
	background: linear-gradient(45deg, #6c757d, #adb5bd);
	color: white;
}

/* Formularios */
.form-container {
	padding: 2rem;
}

.form-label-custom {
	font-weight: 600;
	color: #495057;
	margin-bottom: 0.5rem;
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.form-control-custom, .form-select-custom {
	border-radius: 1rem;
	border: 2px solid #e9ecef;
	padding: 0.75rem 1rem;
	transition: var(--hover-transition);
	font-size: 1rem;
}

.form-control-custom:focus, .form-select-custom:focus {
	border-color: #0d6efd;
	box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
	transform: translateY(-1px);
}

.form-control-custom.is-invalid, .form-select-custom.is-invalid {
	border-color: var(--danger-color);
	box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Alertas */
.alert-custom {
	border-radius: 1rem;
	border: none;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
	padding: 1rem 1.5rem;
}

.alert-custom .btn-close {
	padding: 0.75rem;
}

/* Iconos */
.form-icon {
	color: #0d6efd;
	font-size: 1.1rem;
	width: 20px;
	text-align: center;
}

/* Grupo de botones */
.btn-group-custom {
	display: flex;
	gap: 1rem;
	flex-wrap: wrap;
	justify-content: center;
	margin-top: 2rem;
	padding-top: 1.5rem;
	border-top: 2px solid #f8f9fa;
}

/* Badge para ID */
.id-badge {
	background: linear-gradient(45deg, #6c757d, #adb5bd);
	color: white;
	border-radius: 1rem;
	padding: 0.25rem 0.75rem;
	font-size: 0.8rem;
	font-weight: 600;
	margin-left: auto;
}

/* Responsive */
@media ( max-width : 768px) {
	.form-container {
		padding: 1.5rem;
	}
	.btn-group-custom {
		flex-direction: column;
	}
	.btn-group-custom .btn {
		width: 100%;
		justify-content: center;
	}
	.card-header-custom {
		flex-direction: column;
		text-align: center;
		gap: 0.5rem;
	}
	.id-badge {
		margin-left: 0;
		margin-top: 0.5rem;
	}
}

/* Estados de validación */
.invalid-feedback {
	display: block;
	font-size: 0.875rem;
	margin-top: 0.25rem;
}

.form-text-custom {
	font-size: 0.875rem;
	color: #6c757d;
	margin-top: 0.25rem;
}

/* Animaciones */
@keyframes fadeIn {
	from { 
		opacity: 0;
		transform: translateY(10px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.fade-in {
	animation: fadeIn 0.5s ease-in-out;
}

.submit-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.submit-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Información del crucero */
.crucero-info {
    background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    margin-top: 0.5rem;
    border-left: 4px solid #0d6efd;
}

.crucero-info h6 {
    color: #0d6efd;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.crucero-info p {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

/* Información de disponibilidad */
.disponibilidad-info {
    background: linear-gradient(45deg, #e8f5e8, #f0f8ff);
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    margin-top: 0.5rem;
    border-left: 4px solid #198754;
}

.disponibilidad-info h6 {
    color: #198754;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.disponibilidad-info p {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}
</style>
</head>
<body>
	<div class="container my-5">
		<!-- Card Principal -->
		<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a th:href="@{/reservas}"><i class="fas fa-home me-1"></i>Lista de Reservas</a></li>
					<li class="breadcrumb-item active"><i class="fas fa-file-excel me-1"></i>Reservas</li>
				</ol>
			</nav>
		<div class="card main-card fade-in">
			<!-- Header -->
			<div class="card-header card-header-custom">
				<div class="d-flex align-items-center flex-wrap">
					<i class="fas"
						th:classappend="${modo == 'nuevo'} ? 'fa-plus-circle' : 'fa-edit'"></i>
					<span
						th:text="${modo == 'nuevo'} ? 'Registrar Reserva' : 'Editar Reserva'"></span>
					<span th:if="${reserva.idReserva} != null" class="id-badge">
						ID: <span th:text="${reserva.idReserva}"></span>
					</span>
				</div>
			</div>

			<!-- Body del Formulario -->
			<div class="form-container">
				<!-- Formulario -->
				<form th:object="${reserva}" method="post"
					th:action="${modo == 'nuevo'} ? @{/reservas/guardar} : @{/reservas/editar/{id}(id=${reserva.idReserva})}"
					class="row g-4"
					id="reservaForm"
					novalidate>

					<!-- Errores globales -->
					<div th:if="${#fields.hasGlobalErrors()}" class="col-12">
						<div class="alert alert-danger alert-custom" role="alert">
							<i class="fas fa-exclamation-circle me-2"></i> <strong>Errores
								encontrados:</strong>
							<ul class="mb-0 mt-2">
								<li th:each="e : ${#fields.globalErrors()}" th:text="${e}"></li>
							</ul>
						</div>
					</div>

					<!-- Campo: Crucero -->
					<div class="col-md-6">
						<label for="crucero" class="form-label-custom"> <i
							class="fas fa-ship form-icon"></i> Crucero Programado
						</label> 
						<select th:field="*{crucero}"
							class="form-select form-select-custom"
							th:classappend="${#fields.hasErrors('crucero')} ? ' is-invalid'"
							id="cruceroSelect"
							required>
							<option value="">-- Seleccione --</option>
							<option th:each="c : ${cruceros}" th:value="${c.idCrucero}"
								th:text="${c.barco.nombre + ' / ' + c.puertoOrigen.nombre + ' → ' + c.puertoDestino.nombre + ' (' + c.fechaSalida + ')'}"
								th:attr="data-fecha-salida=${c.fechaSalida}, data-fecha-regreso=${c.fechaRegreso}, data-camarotes-disponibles=${c.camarotesDisponibles}, data-pasajeros-registrados=${c.pasajerosRegistrados}"
								th:selected="${reserva.crucero != null && reserva.crucero.idCrucero == c.idCrucero}">
							</option>
						</select>
						<div class="invalid-feedback"
							th:if="${#fields.hasErrors('crucero')}" th:errors="*{crucero}"></div>
						<div class="form-text-custom text-warning"
							th:if="${#lists.isEmpty(cruceros)}">
							<i class="fas fa-exclamation-triangle me-1"></i> No hay cruceros
							disponibles.
						</div>
						
						<!-- Información del crucero seleccionado -->
						<div id="cruceroInfo" class="crucero-info" style="display: none;">
						    <h6><i class="fas fa-info-circle me-1"></i> Información del Crucero</h6>
						    <p id="cruceroFechas"></p>
						    <p id="cruceroRuta"></p>
						</div>
						
						<!-- Información de disponibilidad -->
						<div id="disponibilidadInfo" class="disponibilidad-info" style="display: none;">
						    <h6><i class="fas fa-chart-bar me-1"></i> Disponibilidad</h6>
						    <p id="infoCamarotes"></p>
						    <p id="infoPasajeros"></p>
						</div>
					</div>

					<!-- Campo: Pasajero -->
					<div class="col-md-6">
						<label for="pasajero" class="form-label-custom"> <i
							class="fas fa-user form-icon"></i> Pasajero
						</label> 
						<select th:field="*{pasajero}"
							class="form-select form-select-custom"
							th:classappend="${#fields.hasErrors('pasajero')} ? ' is-invalid'"
							required>
							<option value="">-- Seleccione --</option>
							<option th:each="p : ${pasajeros}" th:value="${p.idPasajero}"
								th:text="${p.nombre + ' ' + p.apellido}"
								th:selected="${reserva.pasajero != null && reserva.pasajero.idPasajero == p.idPasajero}">
							</option>
						</select>
						<div class="invalid-feedback"
							th:if="${#fields.hasErrors('pasajero')}" th:errors="*{pasajero}"></div>
						<div class="form-text-custom text-warning"
							th:if="${#lists.isEmpty(pasajeros)}">
							<i class="fas fa-exclamation-triangle me-1"></i> No hay pasajeros
							registrados.
						</div>
					</div>

					<!-- Campo: Cantidad de Personas -->
					<div class="col-md-6">
						<label for="cantidadPersonas" class="form-label-custom"> <i
							class="fas fa-users form-icon"></i> Cantidad de Personas
						</label> <input type="number" th:field="*{cantidadPersonas}"
							class="form-control form-control-custom"
							th:classappend="${#fields.hasErrors('cantidadPersonas')} ? ' is-invalid'"
							required min="1" max="20" id="cantidadPersonas" />
						<div class="invalid-feedback"
							th:if="${#fields.hasErrors('cantidadPersonas')}"
							th:errors="*{cantidadPersonas}"></div>
					</div>

					<!-- Campo: Cantidad de Camarotes -->
					<div class="col-md-6">
						<label for="cantidadCamarotes" class="form-label-custom">
							<i class="fas fa-bed form-icon"></i> Cantidad de Camarotes
						</label> <input type="number" th:field="*{cantidadCamarotes}"
							class="form-control form-control-custom"
							th:classappend="${#fields.hasErrors('cantidadCamarotes')} ? ' is-invalid'"
							required min="1" max="10" id="cantidadCamarotes" readonly />
						<div class="invalid-feedback"
							th:if="${#fields.hasErrors('cantidadCamarotes')}"
							th:errors="*{cantidadCamarotes}"></div>
						
					</div>
					<!-- Campo: Fecha Reserva -->
					<div class="col-md-12">
						<label for="fechaReserva" class="form-label-custom"> <i
							class="fas fa-calendar-alt form-icon"></i> Fecha de Reserva
						</label> <input type="date" th:field="*{fechaReserva}"
							class="form-control form-control-custom"
							th:classappend="${#fields.hasErrors('fechaReserva')} ? ' is-invalid'"
							required id="fechaReservaInput" />
						<div class="invalid-feedback"
							th:if="${#fields.hasErrors('fechaReserva')}"
							th:errors="*{fechaReserva}"></div>
						<div class="form-text-custom" id="fechaReservaInfo">
						    <i class="fas fa-info-circle me-1"></i> 
						    <span id="fechaReservaText">Seleccione un crucero para ver las fechas disponibles</span>
						</div>
					</div>

					<!-- Información adicional -->
					<div class="col-12">
						<div class="alert alert-info alert-custom">
							<div class="d-flex align-items-center">
								<i class="fas fa-info-circle me-3 fs-5"></i>
								<div>
									<strong>Información importante:</strong>
									<ul class="mb-0 mt-2">
										<li>La cantidad de camarotes debe ser suficiente para las
											personas</li>
										<li>Verifique la disponibilidad del crucero seleccionado</li>
										<li>La fecha de reserva debe ser anterior a la fecha de salida del crucero</li>
										<li>No se pueden realizar reservas para cruceros que ya han salido</li>
										<li>La reserva está sujeta a la disponibilidad de camarotes</li>
									</ul>
								</div>
							</div>
						</div>
					</div>

					<!-- Botones de acción -->
					<div class="col-12">
						<div class="btn-group-custom">
							<button type="submit" 
							        class="btn btn-success-custom btn-custom"
							        id="submitBtn">
								<i class="fas"
									th:classappend="${modo == 'nuevo'} ? 'fa-plus' : 'fa-save'"></i>
								<span th:text="${modo == 'nuevo'} ? 'Guardar' : 'Actualizar'"></span>
							</button>
							<a th:href="@{/reservas}"
								class="btn btn-secondary-custom btn-custom" id="cancelBtn">
								<i class="fas fa-times"></i> Volver
							</a>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- JavaScript Libraries -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

	<script>
        // Función para obtener parámetros de la URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Función para formatear fechas
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Función para actualizar las restricciones de fecha según el crucero seleccionado
        function actualizarRestriccionesFecha() {
            const cruceroSelect = document.getElementById('cruceroSelect');
            const fechaReservaInput = document.getElementById('fechaReservaInput');
            const fechaReservaInfo = document.getElementById('fechaReservaInfo');
            const fechaReservaText = document.getElementById('fechaReservaText');
            const cruceroInfo = document.getElementById('cruceroInfo');
            const cruceroFechas = document.getElementById('cruceroFechas');
            const cruceroRuta = document.getElementById('cruceroRuta');
            const disponibilidadInfo = document.getElementById('disponibilidadInfo');
            const infoCamarotes = document.getElementById('infoCamarotes');
            const infoPasajeros = document.getElementById('infoPasajeros');
            
            const selectedOption = cruceroSelect.options[cruceroSelect.selectedIndex];
            
            if (selectedOption.value) {
                const fechaSalida = selectedOption.getAttribute('data-fecha-salida');
                const fechaRegreso = selectedOption.getAttribute('data-fecha-regreso');
                const camarotesDisponibles = parseInt(selectedOption.getAttribute('data-camarotes-disponibles')) || 0;
                const pasajerosRegistrados = parseInt(selectedOption.getAttribute('data-pasajeros-registrados')) || 0;
                const textoCrucero = selectedOption.text;
                
                // Mostrar información del crucero
                cruceroInfo.style.display = 'block';
                cruceroFechas.innerHTML = `<strong>Salida:</strong> ${formatDate(fechaSalida)} | <strong>Regreso:</strong> ${formatDate(fechaRegreso)}`;
                cruceroRuta.innerHTML = `<strong>Ruta:</strong> ${textoCrucero}`;
                
                // Mostrar información de disponibilidad
                disponibilidadInfo.style.display = 'block';
                infoCamarotes.innerHTML = `<strong>Camarotes disponibles:</strong> ${camarotesDisponibles}`;
                infoPasajeros.innerHTML = `<strong>Pasajeros registrados:</strong> ${pasajerosRegistrados}`;
                
                // Obtener fecha actual y fecha de salida del crucero
                const hoy = new Date().toISOString().split('T')[0];
                const fechaSalidaCrucero = fechaSalida;
                
                // Verificar si el crucero ya salió
                const hoyObj = new Date();
                const fechaSalidaObj = new Date(fechaSalida);
                
                if (fechaSalidaObj < hoyObj) {
                    // El crucero ya salió, no se pueden hacer reservas
                    fechaReservaInput.disabled = true;
                    fechaReservaInput.value = '';
                    fechaReservaInfo.className = 'form-text-custom text-danger';
                    fechaReservaText.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i> Este crucero ya ha salido. No se pueden realizar reservas.`;
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'Crucero no disponible',
                        text: 'El crucero seleccionado ya ha salido. Por favor, seleccione otro crucero.',
                        confirmButtonColor: '#ffc107'
                    });
                } else {
                    // El crucero está disponible
                    fechaReservaInput.disabled = false;
                    fechaReservaInput.setAttribute('min', hoy);
                    fechaReservaInput.setAttribute('max', fechaSalidaCrucero);
                    fechaReservaInfo.className = 'form-text-custom text-success';
                    fechaReservaText.innerHTML = `<i class="fas fa-check-circle me-1"></i> Fechas disponibles: desde hoy hasta ${formatDate(fechaSalidaCrucero)}`;
                }
            } else {
                // No hay crucero seleccionado
                cruceroInfo.style.display = 'none';
                disponibilidadInfo.style.display = 'none';
                fechaReservaInput.disabled = true;
                fechaReservaInput.value = '';
                fechaReservaInfo.className = 'form-text-custom';
                fechaReservaText.innerHTML = `<i class="fas fa-info-circle me-1"></i> Seleccione un crucero para ver las fechas disponibles`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar parámetros de la URL para mostrar alertas
            const okParam = getUrlParameter('ok');
            const errorParam = getUrlParameter('error');

            if (okParam) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: okParam,
                    confirmButtonColor: '#198754',
                    timer: 3000,
                    timerProgressBar: true,
                    didClose: () => {
                        // Limpiar parámetro de la URL sin recargar
                        const url = new URL(window.location);
                        url.searchParams.delete('ok');
                        window.history.replaceState({}, '', url);
                    }
                });
            }

            if (errorParam) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorParam,
                    confirmButtonColor: '#dc3545',
                    didClose: () => {
                        // Limpiar parámetro de la URL sin recargar
                        const url = new URL(window.location);
                        url.searchParams.delete('error');
                        window.history.replaceState({}, '', url);
                    }
                });
            }

            // Validación y mejoras de UX
            const form = document.getElementById('reservaForm');
            const submitButton = document.getElementById('submitBtn');
            const cancelButton = document.getElementById('cancelBtn');
            const cruceroSelect = document.getElementById('cruceroSelect');
            
            // Inicializar restricciones de fecha
            actualizarRestriccionesFecha();
            
            // Escuchar cambios en el selector de cruceros
            if (cruceroSelect) {
                cruceroSelect.addEventListener('change', actualizarRestriccionesFecha);
            }
            
            if (form) {
                // Validación en tiempo real
                const inputs = form.querySelectorAll('input[required], select[required]');
                inputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        validateField(this);
                    });
                    
                    input.addEventListener('input', function() {
                        if (this.classList.contains('is-invalid')) {
                            validateField(this);
                        }
                    });
                });
                
                function validateField(field) {
                    if (field.value.trim() === '') {
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                }
                
                // Confirmación antes de salir si hay cambios
                let formChanged = false;
                const formFields = form.querySelectorAll('input, select, textarea');
                
                formFields.forEach(field => {
                    const initialValue = field.value;
                    field.addEventListener('input', function() {
                        formChanged = true;
                        window.formChanged = true;
                    });
                });
                
                // Prevenir que se muestre la advertencia al enviar el formulario
                form.addEventListener('submit', function() {
                    formChanged = false;
                    window.formChanged = false;
                    // Mostrar loading en el botón
                    submitButton.classList.add('submit-loading');
                    submitButton.disabled = true;
                });
                
                // Confirmación al salir con cambios sin guardar
                window.addEventListener('beforeunload', function(e) {
                    if (formChanged) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                
                // Validación antes de enviar el formulario
                form.addEventListener('submit', function(e) {
                    let isValid = true;
                    const requiredFields = form.querySelectorAll('[required]');
                    
                    requiredFields.forEach(field => {
                        if (field.value.trim() === '') {
                            field.classList.add('is-invalid');
                            isValid = false;
                        }
                    });

                    // Validación adicional para la fecha de reserva
                    const fechaReservaInput = document.getElementById('fechaReservaInput');
                    const cruceroSelect = document.getElementById('cruceroSelect');
                    const selectedOption = cruceroSelect.options[cruceroSelect.selectedIndex];
                    
                    if (selectedOption.value && fechaReservaInput.value) {
                        const fechaSalida = selectedOption.getAttribute('data-fecha-salida');
                        const fechaReserva = fechaReservaInput.value;
                        
                        if (fechaReserva > fechaSalida) {
                            fechaReservaInput.classList.add('is-invalid');
                            isValid = false;
                            
                            // Crear mensaje de error personalizado
                            const existingError = fechaReservaInput.parentNode.querySelector('.custom-invalid-feedback');
                            if (!existingError) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'invalid-feedback custom-invalid-feedback';
                                errorDiv.textContent = 'La fecha de reserva no puede ser posterior a la fecha de salida del crucero';
                                fechaReservaInput.parentNode.appendChild(errorDiv);
                            }
                        }
                    }

                    if (!isValid) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Campos requeridos',
                            text: 'Por favor, complete todos los campos obligatorios con valores válidos',
                            confirmButtonColor: '#dc3545'
                        });
                        
                        // Re-habilitar el botón
                        submitButton.classList.remove('submit-loading');
                        submitButton.disabled = false;
                    }
                });
            }

            // Confirmación personalizada para cancelar
            if (cancelButton) {
                cancelButton.addEventListener('click', function(e) {
                    if (window.formChanged) {
                        e.preventDefault();
                        Swal.fire({
                            title: '¿Estás seguro?',
                            text: 'Tienes cambios sin guardar. ¿Estás seguro de que deseas salir?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Sí, salir',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = cancelButton.href;
                            }
                        });
                    }
                });
            }
            
            // Cálculo automático de camarotes
            const cantidadPersonasInput = document.getElementById('cantidadPersonas');
            const cantidadCamarotesInput = document.getElementById('cantidadCamarotes');
            
            function calcularCamarotes() {
                const personas = parseInt(cantidadPersonasInput.value) || 0;
                
                if (personas > 0) {
                    // Calcular camarotes: 1 camarote por cada 2 personas (redondeando hacia arriba)
                    const camarotes = Math.ceil(personas / 2);
                    cantidadCamarotesInput.value = camarotes;
                } else {
                    cantidadCamarotesInput.value = '';
                }
            }
            
            // Calcular camarotes cuando cambia la cantidad de personas
            if (cantidadPersonasInput && cantidadCamarotesInput) {
                cantidadPersonasInput.addEventListener('input', calcularCamarotes);
                cantidadPersonasInput.addEventListener('change', calcularCamarotes);
                
                // Calcular inicialmente si ya hay un valor
                if (cantidadPersonasInput.value) {
                    calcularCamarotes();
                }
            }
        });

        // Hacer formChanged global para la confirmación de cancelar
        window.formChanged = false;
    </script>
</body>
</html>